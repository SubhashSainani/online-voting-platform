name: Voting Platform CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NAMESPACE: voting-platform

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔽 Checkout Code
      uses: actions/checkout@v4

    - name: ☕ Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: 📦 Cache Maven Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: 🏗️ Build Maven Projects
      run: |
        echo "Building all Maven projects..."
        mvn clean compile -f service-discovery/pom.xml
        mvn clean compile -f api-gateway/pom.xml
        mvn clean compile -f user-service/pom.xml
        mvn clean compile -f voting-service/pom.xml

    - name: 🧪 Run Tests
      run: |
        echo "Running tests for all services..."
        mvn test -f service-discovery/pom.xml || echo "Service Discovery tests completed"
        mvn test -f api-gateway/pom.xml || echo "API Gateway tests completed"
        mvn test -f user-service/pom.xml || echo "User Service tests completed"
        mvn test -f voting-service/pom.xml || echo "Voting Service tests completed"

    - name: 🐳 Start Minikube
      uses: medyagh/setup-minikube@master
      with:
        minikube-version: 'latest'
        driver: 'docker'
        container-runtime: 'docker'
        start-args: '--memory=4096 --cpus=2'

    - name: 🔧 Enable Minikube Addons
      run: |
        minikube addons enable ingress
        minikube addons enable metrics-server
        echo "Starting minikube tunnel in background..."
        nohup minikube tunnel > tunnel.log 2>&1 &
        sleep 10  # Wait for tunnel to establish

    - name: 🛠️ Configure Docker Environment
      run: |
        echo "Configuring Docker to use Minikube's Docker daemon..."
        eval $(minikube docker-env)
        # Export the environment variables so they persist
        minikube docker-env >> $GITHUB_ENV

    - name: 🏗️ Build Docker Images
      run: |
        echo "Setting up Minikube Docker environment..."
        eval $(minikube docker-env)
        
        echo "Building Docker images..."
        
        echo "🔧 Building Service Discovery..."
        docker build --no-cache -t 2017445/service-discovery:latest ./service-discovery
        
        echo "🚪 Building API Gateway..."
        docker build --no-cache -t 2017445/api-gateway:latest ./api-gateway
        
        echo "👤 Building User Service..."
        docker build --no-cache -t 2017445/user-service:latest ./user-service
        
        echo "🗳️ Building Voting Service..."
        docker build --no-cache -t 2017445/voting-service:latest ./voting-service
        
        echo "✅ All images built successfully!"
        docker images | grep 2017445

    - name: 🎯 Create Kubernetes Namespace
      run: |
        kubectl create namespace voting-platform --dry-run=client -o yaml | kubectl apply -f -

    - name: 🔐 Apply Secrets
      run: |
        echo "Applying Kubernetes secrets..."
        kubectl apply -f k8s/secrets/ -n voting-platform

    - name: 💾 Apply Persistent Storage
      run: |
        echo "Setting up persistent storage..."
        kubectl apply -f k8s/persistence/ -n voting-platform

    - name: ⚙️ Apply ConfigMaps
      run: |
        echo "Applying configuration maps..."
        kubectl apply -f k8s/configmaps/ -n voting-platform

    - name: 🔗 Apply Services
      run: |
        echo "Creating Kubernetes services..."
        kubectl apply -f k8s/services/ -n voting-platform

    - name: 📊 Deploy Database
      run: |
        echo "Deploying MySQL database..."
        kubectl apply -f k8s/deployments/mysql-deployment.yaml -n voting-platform
        echo "Waiting for MySQL to be ready..."
        kubectl wait --for=condition=ready pod -l app=mysql -n voting-platform --timeout=300s

    - name: 🔍 Deploy Service Discovery
      run: |
        echo "Deploying Eureka Service Discovery..."
        kubectl apply -f k8s/deployments/service-discovery-deployment.yaml -n voting-platform
        echo "Waiting for Service Discovery to be ready..."
        kubectl wait --for=condition=ready pod -l app=service-discovery -n voting-platform --timeout=300s

    - name: 🚀 Deploy Microservices
      run: |
        echo "Deploying User Service..."
        kubectl apply -f k8s/deployments/user-service-deployment.yaml -n voting-platform
        
        echo "Deploying Voting Service..."
        kubectl apply -f k8s/deployments/voting-service-deployment.yaml -n voting-platform
        
        echo "Deploying API Gateway..."
        kubectl apply -f k8s/deployments/api-gateway-deployment.yaml -n voting-platform

    - name: ⏳ Wait for Deployments
      run: |
        echo "Waiting for all deployments to be ready..."
        kubectl wait --for=condition=available deployment/user-service -n voting-platform --timeout=300s
        kubectl wait --for=condition=available deployment/voting-service -n voting-platform --timeout=300s
        kubectl wait --for=condition=available deployment/api-gateway -n voting-platform --timeout=300s

    - name: 📈 Apply HPA (Horizontal Pod Autoscaler)
      run: |
        echo "Setting up auto-scaling..."
        kubectl apply -f k8s/hpa/ -n voting-platform

    - name: 🌐 Setup /etc/hosts for voting.local
      run: |
        echo "Setting up voting.local domain..."
        echo "127.0.0.1 voting.local" | sudo tee -a /etc/hosts
        cat /etc/hosts | grep voting.local

    - name: 🚪 Apply Ingress
      run: |
        echo "Setting up Ingress..."
        kubectl apply -f k8s/ingress/ -n voting-platform

    - name: 🔍 Deployment Verification
      run: |
        echo "🔍 Verifying deployment status..."
        echo ""
        echo "📊 All Resources:"
        kubectl get all -n voting-platform
        
        echo ""
        echo "🏠 Pods Status:"
        kubectl get pods -n voting-platform -o wide
        
        echo ""
        echo "🔗 Services:"
        kubectl get services -n voting-platform
        
        echo ""
        echo "🌍 Ingress:"
        kubectl get ingress -n voting-platform
        
        echo ""
        echo "📈 HPA Status:"
        kubectl get hpa -n voting-platform

    - name: 🧪 Health Check Tests
      run: |
        echo "🧪 Running health checks..."
        
        # Wait a bit for services to fully start
        sleep 30
        
        echo "Testing voting.local accessibility..."
        curl -s -o /dev/null -w "%{http_code}" http://voting.local/login | grep -q "200" && echo "✅ voting.local is accessible!" || echo "⚠️ voting.local might not be ready yet"
        
        echo "Testing internal service communication..."
        kubectl exec -it $(kubectl get pod -l app=voting-service -n voting-platform -o jsonpath='{.items[0].metadata.name}') -n voting-platform -- nslookup user-service || echo "DNS resolution test completed"
        
        echo "Checking pod readiness..."
        READY_PODS=$(kubectl get pods -n voting-platform --no-headers | awk '{print $2}' | grep -c "1/1" || echo "0")
        TOTAL_PODS=$(kubectl get pods -n voting-platform --no-headers | wc -l)
        echo "Ready pods: $READY_PODS/$TOTAL_PODS"
        
        if [ "$READY_PODS" -eq "$TOTAL_PODS" ]; then
          echo "✅ All pods are ready!"
        else
          echo "⚠️ Some pods are not ready yet"
          kubectl get pods -n voting-platform
        fi

    - name: 📋 Generate Deployment Report
      if: always()
      run: |
        echo "📋 DEPLOYMENT REPORT" > deployment-report.txt
        echo "===================" >> deployment-report.txt
        echo "" >> deployment-report.txt
        echo "🕐 Deployment Time: $(date)" >> deployment-report.txt
        echo "🔧 Git Commit: ${{ github.sha }}" >> deployment-report.txt
        echo "🌿 Branch: ${{ github.ref_name }}" >> deployment-report.txt
        echo "" >> deployment-report.txt
        echo "📊 Pod Status:" >> deployment-report.txt
        kubectl get pods -n voting-platform >> deployment-report.txt
        echo "" >> deployment-report.txt
        echo "🔗 Services:" >> deployment-report.txt
        kubectl get services -n voting-platform >> deployment-report.txt
        echo "" >> deployment-report.txt
        echo "🌍 Ingress:" >> deployment-report.txt
        kubectl get ingress -n voting-platform >> deployment-report.txt
        
        cat deployment-report.txt

    - name: 🧹 Cleanup on Failure
      if: failure()
      run: |
        echo "🧹 Cleaning up failed deployment..."
        kubectl delete namespace voting-platform --ignore-not-found=true
        echo "Cleanup completed"

    - name: 🎉 Deployment Success
      if: success()
      run: |
        echo ""
        echo "🎉 DEPLOYMENT SUCCESSFUL!"
        echo "========================"
        echo ""
        echo "✅ All services deployed successfully"
        echo "✅ Kubernetes cluster is ready"
        echo "✅ Application is accessible"
        echo ""
        echo "🔗 Access the application:"
        echo "   - Local URL: http://voting.local/login"
        echo "   - Minikube IP: $(minikube ip)"
        echo "   - To access locally: Run 'minikube tunnel' and visit http://voting.local/login"
        echo ""
        echo "📊 Quick status check:"
        kubectl get pods -n voting-platform | grep -c Running || echo "Pod count check"
        echo ""
        echo "🚀 Your voting platform is ready for use!"