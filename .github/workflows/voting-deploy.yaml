name: Voting Platform CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NAMESPACE: voting-platform

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”½ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ðŸ“¦ Cache Maven Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ðŸ—ï¸ Build Maven Projects
      run: |
        echo "Building all Maven projects..."
        mvn clean compile -f service-discovery/pom.xml
        mvn clean compile -f api-gateway/pom.xml
        mvn clean compile -f user-service/pom.xml
        mvn clean compile -f voting-service/pom.xml

    - name: ðŸ§ª Run Tests
      run: |
        echo "Running tests for all services..."
        mvn test -f service-discovery/pom.xml || echo "Service Discovery tests completed"
        mvn test -f api-gateway/pom.xml || echo "API Gateway tests completed"
        mvn test -f user-service/pom.xml || echo "User Service tests completed"
        mvn test -f voting-service/pom.xml || echo "Voting Service tests completed"

    - name: ðŸ³ Start Minikube
      uses: medyagh/setup-minikube@master
      with:
        minikube-version: 'latest'
        driver: 'docker'
        container-runtime: 'docker'
        start-args: '--memory=4096 --cpus=2'

    - name: ðŸ”§ Enable Minikube Addons
      run: |
        minikube addons enable ingress
        minikube addons enable metrics-server
        echo "Starting minikube tunnel in background..."
        nohup minikube tunnel > tunnel.log 2>&1 &
        sleep 10  # Wait for tunnel to establish

    - name: ðŸ› ï¸ Configure Docker Environment
      run: |
        echo "Configuring Docker to use Minikube's Docker daemon..."
        eval $(minikube docker-env)
        # Export the environment variables so they persist
        minikube docker-env >> $GITHUB_ENV

    - name: ðŸ—ï¸ Build Docker Images
      run: |
        echo "Setting up Minikube Docker environment..."
        eval $(minikube docker-env)
        
        echo "Building Docker images..."
        
        echo "ðŸ”§ Building Service Discovery..."
        docker build --no-cache -t 2017445/service-discovery:latest ./service-discovery
        
        echo "ðŸšª Building API Gateway..."
        docker build --no-cache -t 2017445/api-gateway:latest ./api-gateway
        
        echo "ðŸ‘¤ Building User Service..."
        docker build --no-cache -t 2017445/user-service:latest ./user-service
        
        echo "ðŸ—³ï¸ Building Voting Service..."
        docker build --no-cache -t 2017445/voting-service:latest ./voting-service
        
        echo "âœ… All images built successfully!"
        docker images | grep 2017445

    - name: ðŸŽ¯ Create Kubernetes Namespace
      run: |
        kubectl create namespace voting-platform --dry-run=client -o yaml | kubectl apply -f -

    - name: ðŸ” Apply Secrets
      run: |
        echo "Applying Kubernetes secrets..."
        kubectl apply -f k8s/secrets/ -n voting-platform

    - name: ðŸ’¾ Apply Persistent Storage
      run: |
        echo "Setting up persistent storage..."
        kubectl apply -f k8s/persistence/ -n voting-platform

    - name: âš™ï¸ Apply ConfigMaps
      run: |
        echo "Applying configuration maps..."
        kubectl apply -f k8s/configmaps/ -n voting-platform

    - name: ðŸ”— Apply Services
      run: |
        echo "Creating Kubernetes services..."
        kubectl apply -f k8s/services/ -n voting-platform

    - name: ðŸ“Š Deploy Database
      run: |
        echo "Deploying MySQL database..."
        kubectl apply -f k8s/deployments/mysql-deployment.yaml -n voting-platform
        echo "Waiting for MySQL to be ready..."
        kubectl wait --for=condition=ready pod -l app=mysql -n voting-platform --timeout=300s

    - name: ðŸ” Deploy Service Discovery
      run: |
        echo "Deploying Eureka Service Discovery..."
        kubectl apply -f k8s/deployments/service-discovery-deployment.yaml -n voting-platform
        echo "Waiting for Service Discovery to be ready..."
        kubectl wait --for=condition=ready pod -l app=service-discovery -n voting-platform --timeout=300s

    - name: ðŸš€ Deploy Microservices
      run: |
        echo "Deploying User Service..."
        kubectl apply -f k8s/deployments/user-service-deployment.yaml -n voting-platform
        
        echo "Deploying Voting Service..."
        kubectl apply -f k8s/deployments/voting-service-deployment.yaml -n voting-platform
        
        echo "Deploying API Gateway..."
        kubectl apply -f k8s/deployments/api-gateway-deployment.yaml -n voting-platform

    - name: â³ Wait for Deployments
      run: |
        echo "Waiting for all deployments to be ready..."
        kubectl wait --for=condition=available deployment/user-service -n voting-platform --timeout=300s
        kubectl wait --for=condition=available deployment/voting-service -n voting-platform --timeout=300s
        kubectl wait --for=condition=available deployment/api-gateway -n voting-platform --timeout=300s

    - name: ðŸ“ˆ Apply HPA (Horizontal Pod Autoscaler)
      run: |
        echo "Setting up auto-scaling..."
        kubectl apply -f k8s/hpa/ -n voting-platform

    - name: ðŸŒ Setup /etc/hosts for voting.local
      run: |
        echo "Setting up voting.local domain..."
        echo "127.0.0.1 voting.local" | sudo tee -a /etc/hosts
        cat /etc/hosts | grep voting.local

    - name: ðŸšª Apply Ingress
      run: |
        echo "Setting up Ingress..."
        kubectl apply -f k8s/ingress/ -n voting-platform

    - name: ðŸ” Deployment Verification
      run: |
        echo "ðŸ” Verifying deployment status..."
        echo ""
        echo "ðŸ“Š All Resources:"
        kubectl get all -n voting-platform
        
        echo ""
        echo "ðŸ  Pods Status:"
        kubectl get pods -n voting-platform -o wide
        
        echo ""
        echo "ðŸ”— Services:"
        kubectl get services -n voting-platform
        
        echo ""
        echo "ðŸŒ Ingress:"
        kubectl get ingress -n voting-platform
        
        echo ""
        echo "ðŸ“ˆ HPA Status:"
        kubectl get hpa -n voting-platform

    - name: ðŸ§ª Health Check Tests
      run: |
        echo "ðŸ§ª Running health checks..."
        
        # Wait a bit for services to fully start
        sleep 30
        
        echo "Testing voting.local accessibility..."
        curl -s -o /dev/null -w "%{http_code}" http://voting.local/login | grep -q "200" && echo "âœ… voting.local is accessible!" || echo "âš ï¸ voting.local might not be ready yet"
        
        echo "Testing internal service communication..."
        kubectl exec -it $(kubectl get pod -l app=voting-service -n voting-platform -o jsonpath='{.items[0].metadata.name}') -n voting-platform -- nslookup user-service || echo "DNS resolution test completed"
        
        echo "Checking pod readiness..."
        READY_PODS=$(kubectl get pods -n voting-platform --no-headers | awk '{print $2}' | grep -c "1/1" || echo "0")
        TOTAL_PODS=$(kubectl get pods -n voting-platform --no-headers | wc -l)
        echo "Ready pods: $READY_PODS/$TOTAL_PODS"
        
        if [ "$READY_PODS" -eq "$TOTAL_PODS" ]; then
          echo "âœ… All pods are ready!"
        else
          echo "âš ï¸ Some pods are not ready yet"
          kubectl get pods -n voting-platform
        fi

    - name: ðŸ“‹ Generate Deployment Report
      if: always()
      run: |
        echo "ðŸ“‹ DEPLOYMENT REPORT" > deployment-report.txt
        echo "===================" >> deployment-report.txt
        echo "" >> deployment-report.txt
        echo "ðŸ• Deployment Time: $(date)" >> deployment-report.txt
        echo "ðŸ”§ Git Commit: ${{ github.sha }}" >> deployment-report.txt
        echo "ðŸŒ¿ Branch: ${{ github.ref_name }}" >> deployment-report.txt
        echo "" >> deployment-report.txt
        echo "ðŸ“Š Pod Status:" >> deployment-report.txt
        kubectl get pods -n voting-platform >> deployment-report.txt
        echo "" >> deployment-report.txt
        echo "ðŸ”— Services:" >> deployment-report.txt
        kubectl get services -n voting-platform >> deployment-report.txt
        echo "" >> deployment-report.txt
        echo "ðŸŒ Ingress:" >> deployment-report.txt
        kubectl get ingress -n voting-platform >> deployment-report.txt
        
        cat deployment-report.txt

    - name: ðŸ§¹ Cleanup on Failure
      if: failure()
      run: |
        echo "ðŸ§¹ Cleaning up failed deployment..."
        kubectl delete namespace voting-platform --ignore-not-found=true
        echo "Cleanup completed"

    - name: ðŸŽ‰ Deployment Success
      if: success()
      run: |
        echo ""
        echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
        echo "========================"
        echo ""
        echo "âœ… All services deployed successfully"
        echo "âœ… Kubernetes cluster is ready"
        echo "âœ… Application is accessible"
        echo ""
        echo "ðŸ”— Access the application:"
        echo "   - Local URL: http://voting.local/login"
        echo "   - Minikube IP: $(minikube ip)"
        echo "   - To access locally: Run 'minikube tunnel' and visit http://voting.local/login"
        echo ""
        echo "ðŸ“Š Quick status check:"
        kubectl get pods -n voting-platform | grep -c Running || echo "Pod count check"
        echo ""
        echo "ðŸš€ Your voting platform is ready for use!"